# Операционные системы
### #7 Подсистема управления вводом/выводом операционной системе
# СИСТЕМА УПРАВЛЕНИЯ I/O
### Виды деятельности компьютера
- Обработка информации
- Операции ввода-вывода
- С точки зрения программиста:
    - Обработка информации – выполнение команд процессора над данными, находящимися в памяти, независимо от уровня иерархии
    - I/O – обмен данными между памятью и устройствами, внешними по отношению к ней и процессору.
- С точки зрения ОС:
    - Обработка информации – выполнение команд процессора над данными, лежащими в памяти на уровнях не ниже основной памяти.
    - I/O – всё остальное.
# Архитектура компьютера

![image](https://image2url.com/images/1762896563547-8a93df73-cdc1-4427-949a-3883dd2de6c1.jpg)   

**Общие сведения**

Все части компьютера связаны между собой проводниками, называемыми линиями, совокупность которых представляет собой **локальную магистраль.**

Разные проводники, выполняемые сходные функции и служащие сходным целям и протоколы принято называть **шинами**.
# Архитектура компьютера

![image](https://image2url.com/images/1762896858097-eadb7a20-f991-4876-9d18-1870bf57f574.jpg)

**Ширина шины** – количество проводников в шине.
Ширина шины адреса говорит, какое максимальное количество оперативной памяти можно установить в вычислительной системе.

Ширина шины данных – какое максимальное количество информации можно передать по локальной магистрали за один цикл.
# АРХИТЕКТУРА КОМПЬЮТЕРА
### Передача данных из процессора в память
- На адресной шине выставить сигналы для адреса памяти.
- На шине данных выставить сигналы для данных.
- На шине управления выставить сигналы работы с памятью и операции записи.
# АРХИТЕКТУРА КОМПЬЮТЕРА
### Память и устройства I/O
- **Память:**
    - Локализована в пространстве.
    - Ячейки взаимно однозначно отображаются на линейное адресное пространство памяти.
- **Устройства I/O:**
    - Пространственно-разнесены и подключаются к локальной магистрали (ЛМ) через порты I/O
    - Порты I/O взаимно однозначно отображаются на линейное адресное пространство I/O (иногда линейное адресно пространство памяти)
  
![image](https://image2url.com/images/1762897316761-ff227007-8fa4-464b-a120-60e6964127f3.jpg)

# АРХИТЕКТУРА КОМПЬЮТЕРА
### Память и устройства I/O
- Занесение информации в память завершает операцию записи
- Занесение информации в порт часто инициализирует реальное совершение ввода-вывода.
- **Что делать после получения информации через порт и как предоставить информацию для чтения из порта определяют контроллеры устройств**
# АРХИТЕКТУРА КОМПЬЮТЕРА
### Предварительные итоги
- Устройства I/O подключаются к локальной магистрали через порты.
- Могут существовать два адресных пространства – пространство памяти и пространство I/O.
- Порты обычно отображаются в адресное пространство I/O и иногда – в адресное пространство памяти.
- Какое адресное пространство использовать – определяется типом команды или операндов.
- Управление устройством I/O, приёмом и передачей данных через порты и выставлением сигналов на магистрали занимаются контроллеры.
# СИСТЕМА УПРАВЛЕНИЯ I/O
### Структура контроллера устройства
- Регистр состояния (read only).
    - Бит занятости
    - Бит готовности данных
    - Бит ошибки
- Регистр управления (write only).
    - Биты кода команды
    - Биты режима работы
    - Бит готовности команды
- Регистр выходных данных (read only)
- Регистр входных данных (write only)
# СИСТЕМА УПРАВЛЕНИЯ I/O
### Вывод данных на устройство I/O

![image](https://iili.io/f9LZXne.md.jpg)

# СИСТЕМА УПРАВЛЕНИЯ I/O
### Вывод данных на устройство I/O
**Представленная выше система не удобна, т.к. тратится драгоценное процессорное время на опрос устройств.**

Поэтому используется система, когда устройства сами оповещают процессор о своей готовности через линию прерываний.

Если на линии появляется сигнал:
- После выполнения команды процессор обнаруживает сигнал на линии прерываний.
- Сохраняет часть регистров
- Сохраняет часть регистров
Передаёт управление по заранее определённому адресу
- Обработать прерывание.
- Восстанавливает контекст.

Задачи линии можно делегировать контроллеру прерываний.

![image](https://iili.io/f9Qo73v.md.jpg)

# СИСТЕМА УПРАВЛЕНИЯ I/O
### Внешние и программные прерывания, исключительные ситуации
- **Внешние прерывания:**
    - Обнаруживаются процессором **между** выполнением команд.
    - Сохраняется часть контекста перед выполнением **следующей** команды.
    - Не связаны с работой процессора и непредсказуемы.
- **Исключительные ситуации:**
    - Обнаруживаются процессором **во время** выполнением команд.
    - Обнаруживаются процессором во время выполнением команд.
    - Связаны с работой процессора и непредсказуемы.
- **Программные прерывания:**
    - Происходит **в результате** выполнения команды.
    - Сохраняется часть контекста перед выполнением **следующей** команды.
    - Связаны с работой процессора и предсказуемы.
# СИСТЕМА УПРАВЛЕНИЯ I/O
### Прямой доступ к памяти (DMA)
**Чтобы постоянно не беспокоить процессор используется контроллер DMA.**
- Контроллер DMA программируется
- После получения сигнала от устройства I/O запрашивает у процессора управление магистралью.
- Получив управление выставляет адрес и извещает устройство I/O
- Используя шины данных и управление совместно с устройством I/O передаёт информацию.
- Возвращает управление магистралью.

![image](https://iili.io/f9QEue9.md.jpg)

# СИСТЕМА УПРАВЛЕНИЯ I/O
### Основные различия I/O устройств
- Скорость обмена информацией (от нескольких байтов до нескольких ГБ с секунду).
- Возможность использования несколькими процессами параллельно.
- Запоминание выведенной информации для последующего ввода.
- Символьные и блочные.
- Только для ввода информации, только для вывода и read-write устройства.
# СИСТЕМА УПРАВЛЕНИЯ I/O
### Структура системы
- **Уровень Software**
    - Остальные части ядра ОС и пользовательские процессы
    - Базовая подсистема I/O
    - Драйвера устройств
- **Уровень Hardware**
    - Контроллеры устройств
    - Непосредственно устройства. 
 # СИСТЕМА УПРАВЛЕНИЯ I/O
 ### Систематизация внешних устройств
 -  Символьные устройства (клавиатура, модем, терминал и т.д.). 
 - Блочные устройства (магнитные и оптические диски и ленты и т.д.)
 - Сетевые устройства (сетевые карты)
 - Всё остальное (таймеры, графические дисплеи, видеокамеры и т.д.)
 # СИСТЕМА УПРАВЛЕНИЯ I/O
### Интерфейс к драйверам
- **Символьные устройства**
    - Ввести символ – `get`
    - Вывести символ -`put`
- **Блочные устройства** 
    - Прочитать блок – `read`
    - Записать блок – `write`
    - Найти блок – `seek`
- **Для обоих типов**
    - Выполнить произвольную команду – `ioctl`
    - Ре(инициализировать) драйвер и устройство – `open`
    - Временно завершить работу с устройством – `close`
    - Остановить работу драйвера -`stop`
    - Опросить состояние устройства – `poll`
 # СИСТЕМА УПРАВЛЕНИЯ I/O
 ### Функции базовой подсистемы
 - Поддержка блокирующихся, неблокирующихся и асинхронных вызовов
 - Буферизация и кэширование входных и выходных данных
 - Осуществление spooling`a и монопольного захвата внешних устройств
 - Обработка ошибок и прерываний
 - Планирование последовательности запросов на выполнение операций I/O.
# СИСТЕМА УПРАВЛЕНИЯ I/O
### Блокирующиеся, неблокирующиеся и асинхронные вызовы
- При блокирующемся системном вызове процесс переходит из состояния исполнения в состояние ожидание. После выполнения операций ввода-вывода в полном объёме он разблокируется.
- При неблокирующемся системном вызове операции ввода-вывода могут быть выполнены неполностью. Процесс либо неблокируется совсем, либо блокируется не более, чем на определённое время.
- При асинхронном системном вызове процесс никогда не блокируется. Операции ввода-вывода выполняются в полном объёме.
# СИСТЕМА УПРАВЛЕНИЯ I/O
### Буферизация и кэширование
- **Буфер** – это некоторая область памяти для запоминания информации при обмене данными между устройствами, процессами или между устройством и процессом.
- Причины буферизации в базовой подсистеме I/O:
    - Разные скорости приёма-передачи информации участников обмена.
    - Разные объёмы данных, которые могут быть приняты или переданы одновременно.
    - Необходимость копирования данных их приложения в ядро ОС и обратно.
# СИСТЕМА УПРАВЛЕНИЯ I/O
### Буферизация и кэширование
- **Кэш (cache)** – область быстрой памяти, содержащая копию данных, расположенных где-либо в более медленной памяти, предназначенная для ускорения вычислительной системы
- Разница между кэшем и буфером:
    - Буфер служит для согласования параметров участников обмена информацией и для её промежуточного хранения. Кэш применяется для ускорения доступа к данным.
    - Кэш всегда содержит копию данных, существующих ещё где-либо. Буфер часто содержит единственный экземпляр данных в системе.
# СИСТЕМА УПРАВЛЕНИЯ I/O
### Spooling и захват устройств
- **Способы использования неразделяемых устройств**
    - Монопольный захват устройства.
    - Spooling.
- `Spool` – буфер, содержащий входные или выходные данные для устройства, на котором следует избегать чередования его использования различными процессами.
# СИСТЕМА УПРАВЛЕНИЯ I/O
### Обработка прерываний и ошибок
- **Действия ОС:**
    - Определение устройства, выдавшего прерывание
    - Взаимодействие с устройством
    - Проверка успешности выполнения операции.
    - Попытка устранения возможных ошибок.
    - Определение процесса, ожидающего этого прерывания. Перевод его из состояния ожидания в состояние готовность.
    - Если есть ещё процессы с неудовлетворёнными запросами к этому устройству – инициализация нового запроса.
# СИСТЕМА УПРАВЛЕНИЯ I/O 
## Планирование запросов
- **После освобождения устройства необходимо принять решение: какой из запросов в очереди инициировать следующим – планирование запросов.**
    - При занятости устройства запрос ставится в очередь к данному устройству.
    - После освобождения устройства необходимо принять решение: какой из запросов в очереди инициировать следующим – планирование запросов.
- Действия по планированию запросов могут быть частично или полностью делегированы драйверу устройства – функция strategy в интерфейсе драйвера.
# СИСТЕМА УПРАВЛЕНИЯ I/O
### Строение жёсткого диска
У диска есть набор пластин, которые имеют магнитные поверхности с одной или двух сторон, которые принято называть **дорожками**.
Эти поверхности имеют вид концентрических окружностей вокруг оси.

Весь этот набор вращается и равно отстоящие от оси дорожки называют **цилиндром.**

![image](https://snipboard.io/aelGD4.jpg)

# СИСТЕМА УПРАВЛЕНИЯ I/O
### Строение жёсткого диска
Данный цилиндр нарезан на участки – **сектора,** который за один раз может быть записан, либо прочитан.
Для чтения/записи рядом с набором пластин находятся считывающие головки, жёстко сидящие на оси, которая может смещать их относительно диска для выбора дорожки.

Затем головка ожидает, когда приблизится требуемый сектор. И начинает операцию записи/чтения.

![image](https://snipboard.io/aelGD4.jpg)

# СИСТЕМА УПРАВЛЕНИЯ I/O
### Планирование запросов к жёсткому диску
- **Параметры планирования**
- Запрос полностью характеризуется:
    - Типом операции
    - Номером цилиндра
    - Номером дорожки
    - Номером сектора
- **Цель планирования** – минимизировать время, необходимое для выполнения запросов.
- Время выполнения запроса = `transfer_time` + `positional_time`
- `positional_time` = `seek_time` + `positional_latency`
# СИСТЕМА УПРАВЛЕНИЯ I/O
### Планирование запросов к жёсткому диску
- **Получаем, что**
    - Единственным параметром планирования остаётся `seek_time` – время, пропорциональное разнице между номером цилиндра в запросе и номером текущего цилиндра.
- **Алгоритмы планирования:**
    - Алгоритм FCFS `(First Come First Served)` – все цилиндры идут по очереди.
    - Алгоритм SSTF `(Short Seek Time First)` – следующий выполняется тот, до которого меньше всего перемещаться.
# СИСТЕМА УПРАВЛЕНИЯ I/O
### Планирование запросов к жёсткому диску
- **Алгоритмы планирования сканирующие:**
    - Алгоритм `SCAN` – головка всё время движется сначала в одну сторону, затем в другую и выполняет операцию считывания/записи.
    - Алгоритм `LOOK` – смотрит, есть ли в направлении движении головки процессы, в противном случае – головка изменяет направление движения.
    - Алгоритм `C-SCAN` – считывающая головка возвращается в исходное положение перескакиванием без юстировки, т.к. имеется механический ограничитель.
    
    
    

    
    
 
    


    
    


    

   
    
    
    
    

    

    
   
      


 
 
    
    
    
    

    
    
    


 
  
   
    

    









    
    

    
    
    

    
    
    




    
    
    
    







    








    
    


